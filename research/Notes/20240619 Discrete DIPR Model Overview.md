
The provided script simulates a ridesharing system using complex system analysis and modeling principles. It involves creating a dynamic and adaptive environment where multiple agents (riders and drivers) interact over a grid-based city model. The primary focus is on optimizing the allocation of ride requests to drivers, taking into account both travel distance and dynamically updated congestion priorities.

#### Key Components

1. **Grid and Zones**:
   - The city is modeled as a grid of zones, represented as nodes in a directed graph. Roads between zones are represented as edges with associated weights.
   - Each zone tracks the length of its queue, which indicates the congestion level.

2. **Dynamic Priority Calculation**:
   - The system uses a discounted integral priority routing (DIPR) strategy to manage congestion. Each zone's priority is updated based on its historical queue lengths, giving more weight to recent data.
   - Priorities influence the cost of routing decisions, where higher congestion increases the travel cost to a zone.

3. **Event-Driven Simulation**:
   - The simulation is event-driven, handling various events such as ride requests, driver assignments, and ride completions.
   - An event queue manages the sequence and timing of events, ensuring that the system evolves over time.

4. **Agent-Based Modeling**:
   - The simulation includes two types of agents: riders and drivers. Each agent follows specific states and transitions, managed by state machines.
   - Drivers and riders interact through ride requests, with drivers being assigned to riders based on their state and preferences.

5. **Adaptive Routing**:
   - Routing decisions are made dynamically, incorporating both physical distance and congestion priorities. This balances the need to minimize travel distance with the goal of avoiding congested areas.
   - The system continuously updates priorities and routes based on real-time conditions.

6. **State Recording and Analysis**:
   - The simulation records the state of the system at each time step, capturing metrics such as completed rides, total distance traveled, and total cost.
   - These metrics are used to evaluate the performance of the system and compare different routing strategies.

7. **Output and Comparison**:
   - The state of the system is written to a CSV file, allowing for post-simulation analysis and comparison with other simulations.
   - The output data can be used to determine the efficiency and effectiveness of different strategies, such as traditional routing versus DIPR-based routing.

### Data Written to CSV in the StateMap

The `StateMap` class in the script is responsible for recording and writing the state of the simulation at each time step to a CSV file. The data recorded includes key metrics that help evaluate the performance of the ridesharing system. Here is an explanation of the data written to the CSV file:

1. **Time (`time`)**:
   - This column represents the current time step in the simulation. It helps in understanding the progression of events over time and allows for temporal analysis of the system's performance.

2. **Completed Rides (`completed_rides`)**:
   - This column records the cumulative number of rides that have been completed up to the current time step. It is a critical metric for evaluating the effectiveness and efficiency of the ridesharing system in fulfilling ride requests.

3. **Total Distance (`total_distance`)**:
   - This column sums the distances traveled by all completed rides up to the current time step. It provides insights into the total distance covered by drivers in the system and can be used to assess fuel consumption, wear and tear on vehicles, and overall system efficiency.

4. **Total Cost (`total_cost`)**:
   - This column records the cumulative cost incurred by all completed rides up to the current time step. The cost is typically calculated based on the distance traveled and can include factors like fare rates, congestion pricing, and dynamic pricing adjustments.

### Explanation of the Data 

The recorded data serves several important purposes:

1. **Performance Evaluation**:
   - By tracking the number of completed rides, total distance, and total cost over time, the simulation can evaluate how well the ridesharing system is performing. Key performance indicators (KPIs) such as ride fulfillment rate, average travel distance, and total revenue can be derived from this data.

2. **Comparison of Strategies**:
   - The recorded data allows for the comparison of different routing and congestion management strategies. For example, by comparing the CSV files generated by simulations using traditional routing and DIPR-based routing, it is possible to determine which strategy results in faster ride completion, lower total travel distance, or higher total revenue.

3. **Temporal Analysis**:
   - The time series data enables the analysis of how the system's performance evolves over time. Patterns such as peak congestion periods, the impact of dynamic pricing, and the effectiveness of congestion management strategies can be studied.

4. **Simulation Validation**:
   - The data helps validate the simulation by ensuring that the system behaves as expected. For example, a steady increase in completed rides and total distance should be observed over time, and any anomalies can be investigated and addressed.



%% drivers state need to be updated after a ride and then shortest paths need to be calculated after each ride %%
